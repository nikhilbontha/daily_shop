<%- include('layout/header') %>

<main class="cart-page container">
  <h1>Your Cart</h1>

  <% if (!products || products.length === 0) { %>
    <div class="empty-cart">Your cart is empty.</div>
  <% } else { %>
    <div class="cart-wrapper">
      <div style="text-align:right;margin-bottom:12px;">
        <form action="/cart/clear" method="POST" onsubmit="return confirm('Clear your cart? This will remove all items.')">
          <button type="submit" class="btn btn-remove">Clear Cart</button>
        </form>
      </div>
      <table class="cart-table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Subtotal</th>
            <th>Remove</th>
          </tr>
        </thead>
        <tbody>
          <% products.forEach(function(p) { %>
            <tr>
              <td class="product-col">
                <img src="<%= p.images && p.images[0] ? p.images[0] : '/images/default.jpg' %>" alt="<%= p.name %>" />
                <div class="product-meta">
                  <div class="product-name"><%= p.name %></div>
                </div>
              </td>
              <td class="price-col">₹<%= p.price %></td>
              <td class="qty-col">
                <form action="/cart/update" method="POST" class="qty-form" onsubmit="disableFormButtons(this)">
                  <input type="hidden" name="productId" value="<%= p._id %>" />
                  <input type="number" name="qty" value="<%= p.qty %>" min="1" />
                  <button type="submit" class="btn btn-update">Update</button>
                </form>
              </td>
              <td class="subtotal-col">₹<%= p.subtotal %></td>
              <td class="remove-col">
                <form action="/cart/remove" method="POST" onsubmit="disableFormButtons(this)">
                  <input type="hidden" name="productId" value="<%= p._id %>" />
                  <button type="submit" class="btn btn-remove">Remove</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <aside class="cart-summary-box">
        <div class="summary-inner">
          <div class="summary-row">
            <span class="summary-label">Cart Total:</span>
            <span class="summary-value">₹<%= cartTotal || 0 %></span>
          </div>
          <form action="/checkout" method="GET">
            <button type="submit" class="btn btn-checkout">Proceed to Checkout</button>
          </form>
        </div>
      </aside>
    </div>
  <% } %>
</main>

<link rel="stylesheet" href="/css/style.css" />

<script>
  function disableFormButtons(form) {
    Array.from(form.querySelectorAll('button')).forEach(b => b.disabled = true);
    return true;
  }
</script>

